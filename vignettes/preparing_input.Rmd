---
title: "Preparing input"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{preparing_input}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this vignette we'll see, how to prepare an input to the time series deep learning models.
To do so quickly, we'll use functions from `{aion}` package.

```{r setup}
library(data.table)
library(dplyr, warn.conflicts = FALSE)
library(aion)
library(keras)
library(tsibbledata)
library(recipes, warn.conflicts = FALSE)
library(ggplot2)

set.seed(7)
```

We feed a `{keras}` models in two ways, using:
* arrays
* generators
 
Below I present, how to prepare both types of inputs/outputs using `{aion}`.

## Data analysis

As an example we'll the `global_economy` dataset from the `{tsibbledata}` package.

`global_economy` is a n example of **panel dataset**. It simply means that in contains multiple
time series, distinguished with **Country** What we'd like to do, after optional preprocessing such as scaling, imputation etc. is to create a set of arrays (tensors) or a generator, which serves respective batch-level tensors on fly.

```{r data}
head(global_economy)
```

```{r dates}
summary(global_economy$Year)
```


```{r sample_plots}
glob_econ <- as.data.table(global_economy)

sample_countries <- sample(unique(global_economy$Country), 4)

ggplot(glob_econ[Country %in% sample_countries]) +
  geom_line(aes(Year, GDP)) +
  facet_wrap(vars(Country), scales = 'free_y')
```

## Data preprocessing

```{r preprocess}
split_year <- 2000

ge_recipe <- 
  recipe(GDP ~ . , data = glob_econ) %>% 
  step_mutate(Country_idx = Country) %>% 
  step_integer(Country_idx) %>% 
  prep()

train <- 
  glob_econ[Year <= split_year] %>% 
  bake(ge_recipe, .)

setDT(train)

test <- 
  glob_econ[Year > split_year] %>% 
  bake(ge_recipe, .)

setDT(test)
```

## Arrays

Typically, in the time series forecasting field, we can distiguish the following types of variables:

* **past values of the target variable** 
* **future values of the target variable** 
* **past dynamic features** (numeric and categorical)
* **future dynamic features** (numeric and categorical)
* **static features** 

Past target values can be simply treated as a part of the tensor of the past dynamic features.


The simpliest possible scenario is to split the dataset using certain date.
```{r}
KEY         <- 'Country'
INDEX       <- 'Year'
TARGET      <- 'GDP'
NUMERIC     <- c('Growth', 'CPI', 'Imports', 'Exports', 'Population')
CATEGORICAL <- 'Country_idx'

LOOKBACK <- 2
HOIRZON  <- 1

# train_arrays <- 
#   make_arrays(
#     data        = train,
#     key         = KEY,
#     index       = INDEX,
#     lookback    = LOOKBACK,
#     horizon     = HOIRZON,
#     stride      = 4,
#     shuffle     = TRUE,
#     target      = TARGET,
#     categorical = CATEGORICAL,
#     numeric     = NUMERIC
#   )
```

## Generators
